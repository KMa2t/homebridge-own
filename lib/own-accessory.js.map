{"version":3,"sources":["../src/own-accessory.js"],"names":[],"mappings":"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","file":"own-accessory.js","sourcesContent":["import {defaults} from 'lodash';\nimport {Accessory} from 'hap-nodejs';\nimport OwnSocketUtils from './utils/own-socket';\nimport OwnParser from './utils/own-parser';\n\nlet Characteristic;\nlet UUID;\nlet Service;\n\nclass OwnAccessory extends Accessory {\n  constructor(options) {\n    const defaultOptions = {\n      log: console.log\n    };\n    const accessoryOptions = defaults(options, defaultOptions);\n    if (!accessoryOptions.displayName) {\n      accessoryOptions.displayName = accessoryOptions.name;\n    }\n    if (!accessoryOptions.uuid) {\n      accessoryOptions.uuid = UUID.generate(accessoryOptions.name);\n    }\n    super(accessoryOptions.displayName, accessoryOptions.uuid);\n\n    this.options = accessoryOptions;\n    this.name = this.options.name;\n    this.ownId = this.options.ownId;\n    this.log = this.options.log;\n    this.device = this.options.device;\n  }\n\n  // Return list of services provided by this accessory\n  getServices() {\n    const infoService = new Service.AccessoryInformation();\n    infoService.setCharacteristic(Characteristic.Name, 'Sample accessory')\n      .setCharacteristic(Characteristic.Manufacturer, 'Sample manufacturer')\n      .setCharacteristic(Characteristic.Model, 'OWN Item');\n\n    return [infoService];\n  }\n}\n\nclass LightOwnAccessory extends OwnAccessory {\n  getServices() {\n    const config = this.options.config;\n    const socket = new OwnSocketUtils(config.server, config.port);\n\n    const infoService = new Service.AccessoryInformation();\n    infoService.setCharacteristic(Characteristic.Name, `Light ${this.ownId}`)\n      .setCharacteristic(Characteristic.Manufacturer, 'OWN Light')\n      .setCharacteristic(Characteristic.Model, 'OWN Light item');\n\n    const lightService = new Service.Lightbulb(this.name);\n    lightService.getCharacteristic(Characteristic.On)\n      // State setter\n      .on('set', (state, cb) => {\n        socket.send(`*1*${state ? 1 : 0}*${this.ownId}##`, (err) => {\n          if (err) return cb(err);\n          return cb(null);\n        });\n      })\n      // State getter\n      .on('get', (cb) => {\n        socket.send(`*#1*${this.ownId}##`, (err, result) => {\n          if (err) return cb(err);\n          if (result.length === 0) return cb(new Error('no result'));\n          const light = OwnParser.parseCode(result[0]);\n          return cb(null, light.status);\n        });\n      });\n\n    return [infoService, lightService];\n  }\n}\n\nclass AutomationOwnAccessory extends OwnAccessory {\n  getServices() {\n    this.position = {\n      current: 50,\n      target: 50\n    };\n\n    const config = this.options.config;\n    const socket = new OwnSocketUtils(config.server, config.port);\n\n    const infoService = new Service.AccessoryInformation();\n    infoService.setCharacteristic(Characteristic.Name, `Window blind ${this.ownId}`)\n      .setCharacteristic(Characteristic.Manufacturer, 'OWN Window Blind')\n      .setCharacteristic(Characteristic.Model, 'OWN Window Blind item');\n\n    const automationService = new Service.WindowCovering(this.name);\n    automationService.getCharacteristic(Characteristic.CurrentPosition)\n      // State getter\n      .on('set', (state, cb) => {\n        this.log('Set currentposition %d', state);\n      })\n      .on('get', (cb) =>\n        socket.send(`*#2*${this.ownId}##`, (err, result) => {\n          if (err) return cb(err);\n          if (result.length === 0) return cb(new Error('no result'));\n          const automation = OwnParser.parseCode(result[0]);\n          if (automation.status === 0) {\n            return cb(null, 50);\n          } else if (automation.status === 1) {\n            return cb(null, 75);\n          } else if (automation.status === 2) {\n            return cb(null, 25);\n          }\n          return cb(true);\n        })\n      );\n\n    automationService.getCharacteristic(Characteristic.TargetPosition)\n      // State setter\n      .on('set', (state, cb) =>\n        socket.send(`*2*${state === 100 ? 1 : 2}*${this.ownId}##`, (err, result) => {\n          if (err) return cb(err);\n          return cb(true);\n        })\n      )\n      // State getter\n      .on('get', (cb) =>\n        socket.send(`*#2*${this.ownId}##`, (err, result) => {\n          if (err) return cb(err);\n          if (result.length === 0) return cb(new Error('no result'));\n          const automation = OwnParser.parseCode(result[0]);\n          if (automation.status === 0) {\n            return cb(null, 50);\n          } else if (automation.status === 1) {\n            return cb(null, 100);\n          } else if (automation.status === 2) {\n            return cb(null, 0);\n          }\n          return cb(true);\n        })\n      );\n\n    automationService.getCharacteristic(Characteristic.PositionState)\n      // State getter\n      .on('get', (cb) =>\n        socket.send(`*#2*${this.ownId}##`, (err, result) => {\n          if (err) return cb(err);\n          if (result.length === 0) return cb(new Error('no result'));\n          const automation = OwnParser.parseCode(result[0]);\n          if (automation.status === 0) {\n            return cb(null, Characteristic.PositionState.STOPPED);\n          } else if (automation.status === 1) {\n            return cb(null, Characteristic.PositionState.INCREASING);\n          } else if (automation.status === 2) {\n            return cb(null, Characteristic.PositionState.DECREASING);\n          }\n          return cb(true);\n        })\n      );\n\n    automationService.getCharacteristic(Characteristic.HoldPosition)\n      // State setter\n      .on('set', (state, cb) => {\n        // Stop\n        if (!state) return cb(null); // Do nothing on 'Stop holding'\n        return socket.send(`*2*0*${this.ownId}##`, (err, result) => {\n          if (err) return cb(err);\n          return cb(null);\n        });\n      })\n      // State getter\n      .on('get', (cb) =>\n        socket.send(`*#2*${this.ownId}##`, (err, result) => {\n          if (err) return cb(err);\n          if (result.length === 0) return cb(new Error('no result'));\n          const automation = OwnParser.parseCode(result[0]);\n          return cb(null, automation.status === 0);\n        })\n      );\n\n    return [infoService, automationService];\n  }\n}\n\nclass TempSensorOwnAccessory extends OwnAccessory {\n  getServices() {\n    const config = this.options.config;\n    const socket = new OwnSocketUtils(config.server, config.port);\n\n    const infoService = new Service.AccessoryInformation();\n    infoService.setCharacteristic(Characteristic.Name, `Temperature ${this.ownId}`)\n      .setCharacteristic(Characteristic.Manufacturer, 'OWN Temperature')\n      .setCharacteristic(Characteristic.Model, 'OWN Temperature sensor');\n\n    const lightService = new Service.TemperatureSensor(this.name);\n    lightService.getCharacteristic(Characteristic.CurrentTemperature)\n      // State setter\n      .on('get', (cb) => {\n        socket.send(`*#4*${this.ownId}*0##`, (err, result) => {\n          if (err) return cb(err);\n          if (result.length === 0) return cb(new Error('no result'));\n          const temperature = OwnParser.parseCode(result[0]);\n          return cb(null, temperature.status);\n        });\n      });\n\n    return [infoService, lightService];\n  }\n}\n\n\nclass OwnAccessoryFactory {\n  static getAccessories(hbClasses) {\n    Characteristic = hbClasses.Characteristic;\n    UUID = hbClasses.UUID;\n    Service = hbClasses.Service;\n\n    return {LightOwnAccessory, AutomationOwnAccessory, TempSensorOwnAccessory};\n  }\n}\n\nexport {\n  OwnAccessory,\n  LightOwnAccessory,\n  AutomationOwnAccessory,\n  TempSensorOwnAccessory,\n  OwnAccessoryFactory\n};\n"]}